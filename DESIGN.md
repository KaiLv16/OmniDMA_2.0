下面给出 **Markdown（MD）格式** 的技术说明书版本。

风格为：

* 工程技术说明文档
* 结构清晰
* 模块职责明确
* 可直接用于 README / 技术文档 / 专利说明

---

# 上下文管理模块技术说明

## 1. 设计目标

本模块用于支持 WAN 场景下 RDMA 可靠传输的“逻辑无界接收窗口”。设计目标如下：

1. 在不受 RNIC 片上 SRAM 容量限制的前提下，实现可扩展的丢包上下文管理。
2. 保证重传匹配路径为常数时间复杂度。
3. 控制 RNIC 侧内存占用，使其与 QP 数量线性相关且可预测。
4. 在高 BDP、突发丢包及多 QP 并发场景下保持稳定扩展能力。
5. 避免在 RNIC 内部引入复杂动态内存管理逻辑。

---

## 2. 系统约束条件

本设计基于以下系统条件与约束：

* RNIC 片上 SRAM 容量有限。
* 主机内存访问通过 DMA 完成，单次访问延迟约为 ~1μs。
* 首次重传数据包按序到达。
* RNIC 流水线与 QP multiplexing 可部分掩盖访存延迟，但无法完全消除。
* 多个 QP 可能同时扩展丢包窗口。

---

## 3. 总体架构

每个 QP 的丢包状态通过一个 Adamap 链表维护。每个 Adamap 节点记录一个子窗口范围内的数据包接收情况。

为实现“逻辑无界窗口”并控制 RNIC 内存占用，链表采用 NIC–Host 分层存储结构：

### 3.1 RNIC 侧维护内容

* 当前新生成的 Adamap 节点（一级控制路径）
* 当前链表头节点（二级控制路径）

### 3.2 主机侧维护内容

* 链表中间节点
* 尚未进入匹配阶段的尾部节点

该划分基于关键事实：
发送端按序发出的重传数据包在接收端仍按序到达。因此链表访问具有严格顺序性，无需随机跳转。

---

## 4. 共享编织缓冲区设计

### 4.1 内存组织方式

在主机侧申请一块共享内存区域，作为 **Shared Knitting Buffer（共享编织缓冲区）**。

该缓冲区被划分为多个物理地址连续且对齐的内存块。

每个内存块包含：

* 一个 Adamap 数据结构
* 一个 8 字节字段，用于存储下一个节点的物理地址

该设计实现：

* 标准单向链表组织
* RNIC 在 DMA 读取头节点时可同步获取下一节点地址
* 无需额外间接寻址

---

### 4.2 链表管理机制

每个 QP 维护：

* 头指针（由 RNIC 使用）
* 尾指针（由 CPU 维护）

#### 尾部插入流程（CPU 侧执行）

1. CPU 监控重传队列
2. 从空闲链表分配内存块
3. 写入 Adamap 数据
4. 更新尾指针
5. 将节点链接至 QP 丢包链表尾部

#### 头部推进流程（RNIC 执行）

1. 读取当前头节点
2. 匹配完成后推进头指针
3. 将已使用内存块归还空闲链表

---

### 4.3 空闲链表管理

系统维护一个全局空闲链表（Free List），用于管理所有未使用的内存块。

#### 规则

* 分配时：从空闲链表取出块
* 回收时：将块归还空闲链表
* 支持动态扩展与释放

#### 优势

* 支持跨 QP 内存复用
* 避免为每个 QP 预分配固定窗口空间
* 降低峰值内存占用
* 减少内存碎片

---

## 5. 基于水位线的预取机制

### 5.1 问题描述

链表中间节点存储于主机内存。访问节点需一次 DMA 读操作，延迟约为 ~1μs。

在高频重传场景下，重复 DMA 访问可能成为性能瓶颈。

---

### 5.2 设计原理

由于首次重传数据包按序到达，链表访问呈顺序模式，因此可利用预取机制隐藏 DMA 延迟。

---

### 5.3 预取策略

RNIC 本地缓存链表前 `n` 个节点。

#### 重传匹配流程

1. 优先在本地缓存查找
2. 命中则直接处理
3. 未命中则触发 DMA 读取
4. 更新缓存

#### 水位线触发机制

当缓存剩余节点数量低于预设阈值时：

* 异步发起预取
* 提前加载后续节点
* 与数据包处理流程重叠执行

---

### 5.4 参数权衡

参数 `n` 决定：

* RNIC SRAM 占用
* 缓存命中率
* DMA 重叠效果

该参数可根据系统规模与负载特征进行调优。

---

### 5.5 模块独立性

预取模块：

* 不依赖 QP 上下文交换（QPC swapping）
* 不修改 QP 控制状态
* 可独立于主流水线实现
* 不影响 RNIC 主处理逻辑

---

## 6. 性能特性

本上下文管理设计具备以下特性：

* RNIC 侧内存占用固定且可预测
* 支持逻辑无界接收窗口
* 主机内存按需扩展
* 多 QP 共享内存池，提高资源利用率
* 水位线预取机制降低关键路径 DMA 延迟
* 适用于高 BDP、复杂丢包与高并发场景

---

如果你需要，我可以再给你一版：

* 📐 加入空间复杂度公式
* 📊 加入参数推荐值（例如 n=2 或 n=4）
* 🔧 加入伪代码版本
* 🏗 或转成更偏“硬件实现规格”的版本（带状态机说明）

你希望这份文档是放 README，还是论文 Appendix？我可以按用途再优化。
